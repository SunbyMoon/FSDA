tmp_dir=$TMPDIR
if [ "$tmp_dir" == "" ]; then
	tmp_dir="/tmp/"
fi
DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
#source $DIR/../config_file.sh


sample=$1
ref=$2
prep=$3
config_hg19=$4
snplist=$5

cat $snplist | awk '{split($10,a,"/"); if ($4-$3==1 && index($10,"/")!=0 && length($10)==3) printf "%s\t%s\t%s\t%s\t%s\n", $2, $4, $5, a[1], a[2]}' > $prep/snplist.txt

mkdir -p $prep/allele_counts/

########################################################################################################################################
########################################################## Find allele counts ##########################################################
########################################################################################################################################


for file in $sample/*.bam
do
	filename=`basename $file`
	filename=${filename%.bam}
	samtools mpileup -l <(awk '{print $1, $2}' $prep/snplist.txt) -f $config_hg19 -t DPR,DP -uIB  $file  -Q10 -q10 | bcftools call - -Am | python $DIR/vcfParser.py $prep/snplist.txt > $prep/allele_counts/$filename".allele_counts" #&
done


########################################################################################################################################
####################################################### Find fetal distribution ########################################################
########################################################################################################################################
$DIR/findPureFetalFSD.sh $sample $prep > $prep/pure_fetal_hist

########################################################################################################################################
####################################################### Create distribution bins #######################################################
########################################################################################################################################
$DIR/../tools/create_bins.sh $sample $prep/sample_bins.pickle

$DIR/../tools/create_bins.sh $ref $prep/ref_bins.pickle
